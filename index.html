<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Trivo Store Diagn√≥stico Total</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; margin: 20px; }
        h1 { color: #333; }
        .producto { background: #fff; padding: 10px; margin-bottom: 10px; border-left: 4px solid #33c; }
        .error { background: #fee; color: #900; border: 1px solid #900; padding: 10px; margin-bottom: 10px; }
        .ok { background: #e0ffe0; padding: 10px; color: #060; border: 1px solid #060; margin-bottom: 10px; }
        #estadoConexion, #estadoDatos, #estadoFinal { font-weight: bold; margin-top: 10px; }
        #estadoFinal { font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Trivo Store ‚Äì Diagn√≥stico Total</h1>
    <div id="estadoConexion">üîÑ Verificando conexi√≥n a Supabase...</div>
    <div id="estadoDatos">‚è≥ Esperando respuesta de datos...</div>
    <div id="estadoFinal">üîç Iniciando diagn√≥stico...</div>
    <div id="lista-productos">Cargando productos...</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const supabaseUrl = "https://uzqmsbkjontizhovxajx.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6cW1zYmtqb250aXpob3h2YWp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzMDY1NjYsImV4cCI6MjA2Mzg4MjU2Nn0.RtiBzB0k0qzFzsfgUZcIvW1eyu2VmVbEolCWQDkDwbU";
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function diagnostico() {
            const estado = document.getElementById("estadoConexion");
            const estadoDatos = document.getElementById("estadoDatos");
            const estadoFinal = document.getElementById("estadoFinal");
            const lista = document.getElementById("lista-productos");

            try {
                const prueba = await supabase.from("mercancilla").select("id").limit(1);
                if (prueba.error) throw new Error("‚ùå Error conexi√≥n Supabase: " + prueba.error.message);
                estado.innerHTML = "‚úÖ Supabase conectado correctamente.";

                const { data, error } = await supabase.from("mercancilla").select("*");
                if (error) {
                    console.error("‚ùå Error al leer productos:", error);
                    estadoDatos.innerHTML = "‚ùå Fallo al leer productos: " + error.message;
                    estadoFinal.innerHTML = "‚ùå Diagn√≥stico: Fallo de datos desde Supabase.";
                } else if (!data || data.length === 0) {
                    estadoDatos.innerHTML = "‚ö†Ô∏è No hay productos disponibles.";
                    estadoFinal.innerHTML = "‚ö†Ô∏è Diagn√≥stico: Conexi√≥n OK, pero tabla est√° vac√≠a.";
                } else {
                    estadoDatos.innerHTML = "‚úÖ Productos cargados correctamente.";
                    estadoFinal.innerHTML = "‚úÖ Diagn√≥stico exitoso: todo funcionando.";

                    lista.innerHTML = "";
                    data.forEach(p => {
                        const div = document.createElement("div");
                        div.className = "producto";
                        div.innerHTML = `<strong>${p.nombre}</strong><br>${p.descripcion}<br>${p.precio}<br><img src="${p.imagen_url}" width="100"/>`;
                        lista.appendChild(div);
                    });
                }
            } catch (err) {
                console.error("‚ùå Error general:", err);
                estado.innerHTML = "‚ùå Error general en conexi√≥n.";
                estadoDatos.innerHTML = "‚ùå Diagn√≥stico detenido.";
                estadoFinal.innerHTML = "‚ùå Diagn√≥stico: Error general inesperado.";
            }
        }

        window.onload = diagnostico;
    </script>
</body>
</html>
