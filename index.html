<section class="calculadora">
  <h2>Calculadora de Precio Final</h2>

  <label>Precio Base USD:
    <input type="number" id="precioBase" step="0.01">
  </label><br><br>

  <label>Env√≠o USD:
    <input type="number" id="envio" step="0.01">
  </label><br><br>

  <label>Margen Ganancia (%):
    <input type="number" id="ganancia" value="30" step="1">
  </label><br><br>

  <button onclick="calcularPrecio()" class="boton">Calcular</button>
  <button onclick="guardarCalculo()" class="boton" style="background-color:orange; margin-left:10px;">Guardar</button>
  <button onclick="exportarHistorial()" class="exportar" style="background-color:#444;">Exportar Historial (CSV)</button>

  <p id="resultado" style="margin-top:15px;"></p>
  <ul id="historial" style="margin-top:10px; list-style-type:disc;"></ul>
</section>

<script>
  function calcularPrecio() {
    const base = parseFloat(document.getElementById('precioBase').value);
    const envio = parseFloat(document.getElementById('envio').value);
    const margen = parseFloat(document.getElementById('ganancia').value);

    if (!isNaN(base) && !isNaN(envio) && !isNaN(margen)) {
      const totalCosto = base + envio;
      const precioFinal = totalCosto * (1 + margen / 100);
      const gananciaNeta = precioFinal - totalCosto;

      document.getElementById('resultado').innerHTML = `
        <strong>Precio final sugerido:</strong> $${precioFinal.toFixed(2)} USD<br>
        <strong>Ganancia neta estimada:</strong> $${gananciaNeta.toFixed(2)} USD
      `;
    } else {
      document.getElementById('resultado').textContent = "Por favor completa todos los campos.";
    }
  }

  function guardarCalculo() {
    const resultado = document.getElementById("resultado").innerHTML;
    if (resultado) {
      const historial = document.getElementById("historial");
      const item = document.createElement("li");
      item.innerHTML = resultado;
      historial.appendChild(item);
    } else {
      alert("Primero calcula un resultado.");
    }
  }

  function exportarHistorial() {
    const historialItems = document.querySelectorAll("#historial li");
    if (historialItems.length === 0) {
      alert("No hay historial para exportar.");
      return;
    }

    let csv = "Precio Final, Ganancia Neta\n";
    historialItems.forEach(item => {
      const texto = item.textContent;
      const match = texto.match(/\$([\d.]+).*?\$([\d.]+)/);
      if (match) {
        const precio = match[1];
        const ganancia = match[2];
        csv += `${precio},${ganancia}\n`;
      }
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "historial_trivo.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
